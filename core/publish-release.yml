gate:prod:publish:
  extends:
   - .setup_base
  stage: prod publish
  script:
    - cd $DIR
    - '[[ -z "${VERSION_BUMPED}" ]] && { echo "!!! Version not bumped, continuing with release !!!"; } || { echo "Version bumped, not doing release" && exit 1; }'
    - echo "Expected to release $VERSION...checking for issues..."
    - $CI_PROJECT_DIR/version.py get-base-version
    - echo "Release is a GO!"
  when: manual
  allow_failure: false
  interruptible: true
  resource_group: $APP-release
  rules:
    - if: $ENABLE_CONTINUOUS_DEPLOYMENT
      when: on_success
    - !reference [.release_rules, rules]

publish:release:
  extends:
    - .publish
  stage: prod publish
  rules:
    - !reference [.release_rules, rules]
  needs:
    - job: 'get:version'
      artifacts: true
    - job: 'build:release'
      artifacts: true
    - job: 'gate:prod:publish'
      artifacts: true

gitlab:release:
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  stage: prod publish
  script:
    - echo "Releasing $APP version $VERSION"
  release:
    name: 'Release $TAG'
    description: '$DESCRIPTION'
    tag_name: '$TAG'
    ref: '$CI_COMMIT_SHA'
  rules:
    - !reference [.release_rules, rules]
  needs:
    - job: 'gate:prod:publish'
      artifacts: true
    - job: 'get:version'
      artifacts: true
    - job: 'build:release'
      artifacts: true
    - job: 'test:release'
      artifacts: true
