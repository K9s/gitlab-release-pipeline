gate:prod:
  extends:
    - .gate_base
  stage: prod
  rules:
    - if: $RP_DEPLOYS_DISABLED == 'true' || $RP_PRODUCTION_DEPLOY_DISABLED == 'true'
      when: never
    - if: $RP_ENABLE_CONTINUOUS_DEPLOYMENT == 'true' && $CI_COMMIT_REF_NAME == $CI_DEFAULT_BRANCH
      when: on_success
    - !reference [.release_rules, rules]

.deploy:prod:
  environment:
    deployment_tier: production
    name: prod
    on_stop: deploy:prod:stop
  needs:
    - job: 'set:version'
    - job: 'gate:prod'

deploy:prod:
  extends:
    - .deploy_base
    - .deploy
    - .deploy:prod
    - .deploy:override
  stage: prod
  variables:
    GIT_STRATEGY: none
  rules:
    - if: $RP_DEPLOYS_DISABLED == 'true' || $RP_PRODUCTION_DEPLOY_DISABLED == 'true'
      when: never
    - !reference [.release_rules, rules]
  resource_group: global-prod-deploy

.deploy:prod:stop:
  environment:
    deployment_tier: production
    name: prod
    action: stop

deploy:prod:stop:
  extends:
    - .deploy_base
    - .deploy_stop
    - .deploy:prod:stop
  stage: prod
  rules:
    - if: $RP_DEPLOYS_DISABLED == 'true' || $RP_PRODUCTION_DEPLOY_DISABLED == 'true'
      when: never
    - !reference [.release_rules, rules]
  needs:
    - job: 'set:version'
    - job: 'deploy:prod'
  when: manual
